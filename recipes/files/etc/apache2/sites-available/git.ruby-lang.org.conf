<VirtualHost *:80>
        ServerName git.ruby-lang.org
        ServerAdmin webmaster@ruby-lang.org

        # for let's encrypt
        DocumentRoot /var/www/git.ruby-lang.org

        RedirectMatch permanent ^/(?!.well-known)(.*) https://git.ruby-lang.org/$1
</VirtualHost>

<VirtualHost *:443>
        ServerName git.ruby-lang.org
        ServerAdmin webmaster@ruby-lang.org

        SSLEngine on
        SSLCertificateFile    /etc/letsencrypt/live/git.ruby-lang.org-0001/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/git.ruby-lang.org-0001/privkey.pem

        TimeOut 300

        RewriteEngine On
        RewriteCond %{QUERY_STRING} ^id=([0-9a-fA-F]{40})$
        RewriteRule ^/ruby\.git/commit/?$ https://github.com/ruby/ruby/commit/%1 [R=permanent,L,NE,QSD]
        RewriteCond %{QUERY_STRING} ^id=([0-9a-fA-F]{40})$
        RewriteRule ^/ruby\.git/commit/(.*)$ https://github.com/ruby/ruby/blob/%1/$1 [R=permanent,L,NE,QSD]
        RewriteCond %{QUERY_STRING} ^id=([0-9a-fA-F]{40})$
        RewriteRule ^/ruby\.git/tree/(.*)$ https://github.com/ruby/ruby/blob/%1/$1 [R=permanent,L,NE,QSD]
        RewriteCond %{QUERY_STRING} ^id=([0-9a-fA-F]{40})(&showmsg=1)?$
        RewriteRule ^/ruby\.git/log/(.*)$ https://github.com/ruby/ruby/commits/%1/$1 [R=permanent,L,NE,QSD]

        Alias /cgit-css "/usr/share/cgit/"
        Alias /robots.txt "/var/www/git.ruby-lang.org/robots.txt"

        ScriptAlias /webhook "/home/git/git.ruby-lang.org/cgi-bin/webhook.cgi/"
        <Directory "/home/git/git.ruby-lang.org/cgi-bin/">
                AllowOverride None
                Options ExecCGI FollowSymlinks
                Require all granted
        </Directory>

        ScriptAlias / "/usr/lib/cgit/cgit.cgi/"
        <Directory "/usr/lib/cgit/">
                AllowOverride None
                Options ExecCGI FollowSymlinks
                Require all granted
                RLimitNPROC 5
        </Directory>
</VirtualHost>
